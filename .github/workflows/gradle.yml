name: Java CI with Gradle

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Make application.properties
        run: touch ./src/main/resources/application.properties

      - name: Deliver application.properties
        run: echo "${{ secrets.APPLICATION }}" > ./src/main/resources/application.properties

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle Wrapper
        run: ./gradlew build -x test

      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2            

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: menten4859/timo-repo:latest
          platforms: |
            linux/amd64
            linux/arm64
      
      # docker-compose.yml 생성 (GitHub Actions 환경 변수 -> 실제 파일)
      - name: Create docker-compose file
        run: |
          echo "${{ secrets.DOCKER_COMPOSE_SPRINGBOOT }}" > ./docker-compose.yml
      
      # SSH로 EC2 접속, 기존 폴더 정리
      - name: Remove old compose folder on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_PEM }}
          script: |
            echo "Removing old /home/ubuntu/compose folder..."
            rm -rf /home/ubuntu/compose
            mkdir -p /home/ubuntu/compose
      
      # docker-compose.yml 업로드
      - name: Upload docker-compose file to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_PEM }}
          source: "./docker-compose.yml"
          target: "/home/ubuntu/compose"
          overwrite: true

      # # (선택) Nginx 설정 파일들(timo-api-blue.conf, timo-api-green.conf) 업로드
      # - name: Upload Nginx conf files
      #   uses: appleboy/scp-action@master
      #   with:
      #     host: ${{ secrets.EC2_HOST }}
      #     username: ubuntu
      #     key: ${{ secrets.EC2_PEM }}
      #     source: "./nginx-conf/*"               # 로컬에 nginx-conf/timo-api-blue.conf, timo-api-green.conf가 있다고 가정
      #     target: "/etc/nginx/conf.d"
      #     overwrite: true
      
      # Green 배포 및 Nginx 전환
      - name: Deploy Green version and switch Nginx
        uses: appleboy/ssh-action@master
        env:
          COMPOSE: "/home/ubuntu/compose/docker-compose.yml"
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_PEM }}
          port: 22
          envs: COMPOSE
          script: |
            # 도커 로그인
            sudo docker login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}"
            
            # Green 서비스 pull & up
            sudo docker-compose -f $COMPOSE pull spring-green
            sudo docker-compose -f $COMPOSE up -d spring-green
            
            # 헬스체크 (최대 10회, 5초 간격)
            HEALTH_STATUS=0
            for i in {1..10}; do
              HEALTH_STATUS=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:8081/actuator/health)
              if [ "$HEALTH_STATUS" -eq 200 ]; then
                echo "Green 서비스 헬스체크 성공 (HTTP $HEALTH_STATUS)"
                break
              else
                echo "Green 서비스 헬스체크 실패 (HTTP $HEALTH_STATUS), 재시도 중..."
                sleep 5
              fi
            done
            
            if [ "$HEALTH_STATUS" -ne 200 ]; then
              echo "Green 서비스 헬스체크 실패. 배포 중단."
              exit 1
            fi
            
            # 헬스체크 성공 시, Nginx 설정 전환
            # => timo-api-green.conf를 timo-api.conf로 복사
            sudo cp /etc/nginx/conf.d/timo-api-green.conf /etc/nginx/conf.d/timo-api.conf
            sudo nginx -t && sudo systemctl reload nginx
            
            # 전환 후 Blue 서비스 중지
            sudo docker-compose -f $COMPOSE stop spring-blue
